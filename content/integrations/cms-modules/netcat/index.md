# Платежный плагин RBKmoney для Netcat

- Модуль доступен для скачивания в нашем [открытом репозитории на GitHub](https://github.com/rbkmoney/rbkmoney-cms-netcat/releases/latest);
- Текущая стабильная версия модуля - 1.0;

# Установка и настройка модуля

## Установка

Для создания установочного архива модуля необходимо упаковать все файлы модуля.
Для упаковки модуля нужно использовать архиватор поддерживающий формат «tar», либо скачать готовый архив по ссылке выше.

Рекомендуется файлу архива присваивать следующее название:
Производитель_КлючевоеСлово_Версия_ЯдроСистемы.Расширение

Производитель - название компании-производителя модуля (латинскими буквами)
КлючевоеСлово - ключевое слово модуля
Версия - версия модуля
ЯдроСистемы - версия ядра системы
Расширение - tgz

Пример:
rbkmoney_1_1.tgz

## Инструкция по установке

1. Скачайте и установите NetCat на сервер (https://netcat.ru/democentre).
1. Установите модуль RBKmoney (Инструменты->Установка модуля).
   После установки необходимо перезагрузить страницу.
1. Далее нужно заполнить необходимые поля для корректной работы модуля.
   Сделать это можно через админку в настройках модуля (http://ваш_сайт/netcat/admin)
   Настройки­>Управление модулями, клик по названию модуля (не шестеренка).
   Поля настройки модуля описаны ниже.
   После заполнения полей нажмите кнопку сохранить в конце страницы.
1. Перейдите в настройки модуля Интернет-магазин (Настройки­>Интернет­магазин),
   в меню слева выберите пункт Настройки->Оплата.
   Добавьте новый способ оплаты с указанием платежной системы RBKmoney (кнопка "Добавить" внизу страницы).
1. Для работы модуля необходимо проставить всем товарам ставки НДС, допустимые значения:
   0 (соответствует 0%);
   10 (соответствует 10%);
   18 (соответствует 18%).
   Пустое поле = без НДС.
1. Настроить частоту работы рекуррентов можно в разделе Инструменты->Управление задачами.
   Для того, чтоб задать интервал выполнения скрипта нажмите на шестеренку напротив записи со ссылкой /netcat/modules/rbkmoney/recurrentCron.php 
   Для того, чтоб запустить скрипт вручную нажмите на ссылку /netcat/modules/rbkmoney/recurrentCron.php, которая находится в этом разделе.

# Настройка модуля

## Инструкция по настройке

1. API ключ - его необходимо взять в кабинете RBKmoney нажав по кнопке "перейти в магазин" и выбрав пункт API ключ 
   в меню слева
1. ID магазина - также берется в кабинете в пункте "Детали магазина"
1. Страница успешной оплаты — это страница, на которую пользователь будет направляться после оплаты.
   Страницу необходимо создать в Netcat’е самостоятельно, и здесь указать полную
   ссылку вида http://вашсайт.рф/ссылка-на-страницу
1. Тип списания средств - укажите "мгновенное списание" чтобы средства у пользователя списывались сразу
   (недостаток в том, что возврат списанных средств - действие платное),
   "холд" чтобы средства блокировались на карте и списывались только после подтверждения
   (возможно сделать во вкладке "Транзакции" модуля или в кабинете)
1. Списание средств по окончанию срока холдирования - если вы ничего не сделаете на протяжении ## дней
   (период блокирования средств), то деньги спишутся в пользу магазина или вернутся назад плательщику
   в зависимости от этой настройки. Работает при выбранном в п.4 значении "Холд"
1. Статус инвойса при холде - данная опция указывает в какой статус переводить инвойс в неткате при
   инициализации холда средств. Работает при выбранном в п.4 значении "Холд".
   Если там указано "Принят" - то статус инвойса после инициализации холда средств переводится в "Принят".
   При подтверждении холда (окончательном списании средств в пользу магазина) статус инвойса
   переводится в "Оплачен".
1. Отображение кардхолдера в форме оплаты - отображать или нет в форме ввода данных карты строку "Владелец карты".
1. Затенять карточный CVV-код - затенять ли (забивать звездочками) вводимый параметр CVV на форме
   ввода данных карты или не затенять и отображать вводимые цифры
1. Фискализация по 54-ФЗ - выберите "Использовать" если вы пользуетесь решением по фискализации от RBKmoney

## Рекуррентные товары

1. Во вкладке "товары для регулярных платежей" необходимо указать артикулы тех товаров, которые будут
   работать как "подписки на регулярные платежи", а также настроить регулярные задачи согласно инструкции выше. 
1. После покупки такого товара-подписки (не важно есть ли в корзине еще обычные товары или нет)
   с пользователя списываются средства в размере стоимости этого товара. Далее происходят регулярные
   списания по расписанию, указанному вами в настройках выше. При каждом регулярном списании во вкладке
   "Транзакции" появится новая транзакция, соответствующая данной регулярной оплате,
   в неткате появится инвойс, соответствующий этому списанию. 
1. В момент первой оплаты товара-подписки конкретным пользователем сумма подписки для дальнейших списаний фиксируется.
   Если вы отредактируете стоимость товара-подписки, это не скажется на суммах, на которые подписались
   пользователи до этого, с них продолжат списываться зафиксированные ранее суммы. 
1. Если в момент списания на карте не было денег, или возникла иная проблема - повторных попыток списания
   этой регулярной оплаты не будет, но, когда наступит время следующего списания - оно также будет проведено один раз. 
1. Удалить подписки на регулярные списания и просмотреть текущие можно во вкладке "Регулярные платежи" модуля. 
1. Контроля уникальности подписок нет. Один и тот же пользователь может несколько раз подписаться 
   на один и тот же товар-подписку, и средства с него будут списываться несколько раз за период.
